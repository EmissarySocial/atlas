{{- $q := .QueryParam "q" -}}
{{- $lat := .QueryParam "lat" -}}
{{- $lng := .QueryParam "lng" -}}
{{- $zoom := .QueryParam "zoom" -}}

<div class="app">
	<div id="map" class="pos-absolute-four-corners"></div>

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
		crossorigin=""/>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
		crossorigin="">
	</script>

	<script>
		var map = L.map('map')

		showResults();

		async function showResults() {
			showMap();

			var data = await fetch("/{{.StreamID}}/view-results?q={{queryEscape $q}}")
			var items = await data.json()

			for (item of items) {
				var coordinates = item.place.location.coordinates
				latLng = L.latLng(coordinates[1], coordinates[0])

				var marker = L.marker(latLng).addTo(map);
				marker.bindPopup(item.summary + "<br><br><a href='" + item.url + "' class='bold'>View &rarr;</a>");
			}
		}

		async function showMap() {

			var loc = await getSavedLocation();

			map.setView([loc.latitude, loc.longitude], loc.zoom);
			map.attributionControl.setPrefix("")
			map.zoomControl.setPosition("topright");

			L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}).addTo(map);

			map.on("zoomend", saveLocation)
			map.on("moveend", saveLocation)
		}

		function saveLocation() {
			var zoom = map.getZoom()
			var latLng = map.getCenter()
			localStorage.setItem("latitude", latLng.lat);
			localStorage.setItem("longitude", latLng.lng);
			localStorage.setItem("zoom", zoom);
		}

		async function getSavedLocation() {

			var storedLatitude = localStorage.getItem("latitude");
			var storedLongitude = localStorage.getItem("longitude");
			var storedZoom = localStorage.getItem("zoom") || 17;

			// If the user already has a saved location, then use that
			if ((storedLatitude != null) && (storedLongitude != null)) {
				return {
					latitude: parseFloat(storedLatitude),
					longitude: parseFloat(storedLongitude),
					zoom: parseInt(storedZoom)
				};
			}

			// Find the user's location based on their IP address
			var response = await fetch("/.geocode/ip");
			var result = await response.json();
			result.zoom = 17;

			return result;
		}

	</script>

</div>