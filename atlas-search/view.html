{{- $q := .QueryParam "q" -}}
{{- $lat := .QueryParam "lat" -}}
{{- $lng := .QueryParam "lng" -}}
{{- $zoom := .QueryParam "zoom" -}}
{{- $mapTiles := .MapTiles -}}

<style>
	#controls {
		z-index:1000; 
		background-color:color-mix(in srgb, var(--black), transparent 60%);
	}
</style>

<div class="app" script="init send SelectNav(id:'{{.StreamID}}')">
	<div id="map" class="pos-absolute-four-corners"></div>
	<div id="controls" class="pos-absolute-bottom-left text-sm padding-xs rounded">
		<div>
			<button id="follow-button" class="primary">Follow this Map</button>
			<button id="qrcode-button">{{icon "qr-code"}} QR Code</button>
		</div>

		<div class="margin-top-sm text-xs" style="color:var(--white);">
			<span hx-get="/{{.StreamID}}/intent" class="clickable intentMarker-account">&nbsp;</span>
		</div>
	</div>

	<link rel="stylesheet" href="/.themes/global/resources/leaflet-1.9.4/leaflet.css"/>
	<script src="/.themes/global/resources/leaflet-1.9.4/leaflet.js"></script>

	<script>
		var map = L.map('map')
		var markerGroup = L.featureGroup().addTo(map)

		showMap();

		async function showMap() {

			await getLocation();
			map.attributionControl.setPrefix("")
			map.zoomControl.setPosition("topright");

			L.tileLayer('{{$mapTiles.Href}}', {
				minZoom: 0,
				maxZoom: 19,
				attribution: '{{$mapTiles.Description}}'
			}).addTo(map);

			map.on("zoomend", setLocation)
			map.on("moveend", setLocation)

			showResults()
		}

		function setLocation() {
			var zoom = map.getZoom()
			var latLng = map.getCenter()

			if ((latLng.lat != NaN) && (latLng.lng != NaN)) {
				localStorage.setItem("latitude", latLng.lat);
				localStorage.setItem("longitude", latLng.lng);
				localStorage.setItem("zoom", zoom);
			}

			showResults()
		}

		async function showResults() {

			// get bounding box for the map area
			var bounds = map.getBounds()
			var north = bounds._northEast.lat
			var east = bounds._northEast.lng
			var south = bounds._southWest.lat
			var west = bounds._southWest.lng
			var polygon = [
				east, north,
				east, south,
				west, south,
				west, north,
				east, north,
			].join(",")

			console.log(bounds)
			console.log(polygon)

			// Update the browser's location
			var queryParams = new URLSearchParams(window.location.search);
			queryParams.delete("location")
			queryParams.set("location", polygon)
			
			var queryString = queryParams.toString()

			// Push the location into the browser's URL bar
			history.replaceState(null, null, "?" + queryString)

			// Update controls with new QueryString 
			document.getElementById("follow-button").setAttribute("hx-post", "/.searchQuery?types=Event&forward=/{{.StreamID}}/intent%3Fintent%3Dfollow%26object=&" + queryString)
			document.getElementById("qrcode-button").setAttribute("hx-get", "/{{.StreamID}}/view-qrcode?" + queryString)

			if (typeof htmx != "undefined") {
				htmx.process("#controls")
			}

			// Rewrite markers on the map
			var data = await fetch("/{{.StreamID}}/view-results?q={{queryEscape $q}}&location=" + polygon)
			var items = await data.json()
			markerGroup.clearLayers();

			for (item of items) {
				var coordinates = item.location.coordinates
				latLng = L.latLng(coordinates[1], coordinates[0])

				var marker = L.marker(latLng).addTo(markerGroup);

				if ((item.iconUrl != null) && (item.iconUrl != "")) {
					item.summary = "<img src='" + item.iconUrl +"' class='width-100% block margin-bottom'>" + item.summary
				}

				item.summary = "<a href='" + item.url + "' class='block text-plain text-nocolor width-320'>" + item.summary + "<br><br><div class=link>View &rarr;</div></a>"
				marker.bindPopup(item.summary);
			}

		}

		async function getLocation() {

			// 1. Look for lat/lng set in the URL querystring
			var queryString = window.location.search;

			if (queryString != "") {
				var queryParams = new URLSearchParams(queryString);
				var location = queryParams.get("location")
				console.log(location)
				if (location != null) {
					var points = location.split(",")
					console.log(points)
					if (points.length == 10) {
						var northEast = L.latLng(points[1], points[0]);
						var southWest = L.latLng(points[5], points[4]);
						var bounds = L.latLngBounds(northEast, southWest);
						console.log(bounds)
						map.fitBounds(bounds)
						return
					}
				}
			}

			// 2. Look for lat/lng in the localStorage
			var storedLatitude = localStorage.getItem("latitude");
			var storedLongitude = localStorage.getItem("longitude");

			// If the user already has a saved location, then use that
			if ((storedLatitude != null) && (storedLongitude != null)) {
				var latitude = parseFloat(storedLatitude)
				var longitude = parseFloat(storedLongitude)

				console.log(latitude)
				console.log(latitude == NaN)
				console.log(longitude)
				if ((latitude != NaN) && (longitude != NaN)) {
					map.setView([latitude, longitude], getZoom());
					return
				}
			}

			// 3. Look for the user's APPROXIMATE location based on their IP address
			var response = await fetch("/.geocode/network");
			var result = await response.json();
			map.setView([result.latitude, result.longitude], getZoom());
		}

		function getZoom() {
			result = parseInt(localStorage.getItem("zoom"))

			if ((result != NaN) && (result >= 0) & (result <= 19)) {
				return result
			}

			return 13
		}

		function parseJSON(value) {
			try{
				return JSON.parse(value)
			} catch (err) {
				return null
			}
		}

	</script>

</div>