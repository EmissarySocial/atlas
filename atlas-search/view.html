{{- $q := .QueryParam "q" -}}
{{- $lat := .QueryParam "lat" -}}
{{- $lng := .QueryParam "lng" -}}
{{- $zoom := .QueryParam "zoom" -}}

<div class="app" script="init send SelectNav(id:'{{.StreamID}}')">
	<div id="map" class="pos-absolute-four-corners"></div>

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
		crossorigin=""/>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
		crossorigin="">
	</script>

	<script>
		var map = L.map('map')
		var markerGroup = L.featureGroup().addTo(map)

		showMap();

		async function showMap() {

			var loc = await getSavedLocation();

			map.setView([loc.latitude, loc.longitude], loc.zoom);
			map.attributionControl.setPrefix("")
			map.zoomControl.setPosition("topright");

			L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				minZoom: 0,
				maxZoom: 19,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}).addTo(map);

			map.on("zoomend", setLocation)
			map.on("moveend", setLocation)

			showResults()
		}

		function setLocation() {
			var zoom = map.getZoom()
			var latLng = map.getCenter()
			localStorage.setItem("latitude", latLng.lat);
			localStorage.setItem("longitude", latLng.lng);
			localStorage.setItem("zoom", zoom);

			showResults()
		}

		async function showResults() {

			// get bounding box for the map area
			var bounds = map.getBounds()
			var north = bounds._northEast.lat
			var east = bounds._northEast.lng
			var south = bounds._southWest.lat
			var west = bounds._southWest.lng
			var polygon = [
				west, north,
				east, north,
				east, south,
				west, south,
				west, north, // close the polygon
			].join(",")

			var data = await fetch("/{{.StreamID}}/view-results?q={{queryEscape $q}}&place=" + polygon)
			var items = await data.json()

			markerGroup.clearLayers();

			for (item of items) {
				var coordinates = item.place.location.coordinates
				latLng = L.latLng(coordinates[1], coordinates[0])

				var marker = L.marker(latLng).addTo(markerGroup);

				if (item.iconUrl != "") {
					item.summary = "<img src='" + item.iconUrl +"' class='width-100% block margin-bottom'>" + item.summary
				}

				item.summary = "<a href='" + item.url + "' class='block text-plain text-nocolor width-320'>" + item.summary + "<br><br><div class=link>View &rarr;</div></a>"
				marker.bindPopup(item.summary);
			}
		}

		async function getSavedLocation() {

			// 1. Look for lat/lng set in the URL querystring
			var queryString = window.location.search;

			if (queryString != "") {
				var queryParams = new URLSearchParams(queryString);

				var latitudeString = queryParams.get("latitude")
				var longitudeString = queryParams.get("longitude")

				var latitude = parseFloat(latitudeString)
				var longitude = parseFloat(longitudeString)
				
				if ((latitude != NaN) && (longitude != NaN)) {
					localStorage.setItem("latitude", latitude)
					localStorage.setItem("longitude", longitude)
					
					return {
						latitude: latitude,
						longitude: longitude,
						zoom: getStoredZoom()
					}
				}
			}

			// 2. Look for lat/lng in the localStorage
			var storedLatitude = localStorage.getItem("latitude");
			var storedLongitude = localStorage.getItem("longitude");
			var storedZoom = getStoredZoom()

			// If the user already has a saved location, then use that
			if ((storedLatitude != null) && (storedLongitude != null)) {
				return {
					latitude: parseFloat(storedLatitude),
					longitude: parseFloat(storedLongitude),
					zoom: parseInt(storedZoom)
				};
			}

			// 3. Look for the user's APPROXIMATE location based on their IP address
			var response = await fetch("/.geocode/ip");
			var result = await response.json();
			result.zoom = getStoredZoom();

			return result;
		}

		function getStoredZoom() {
			result = parseInt(localStorage.getItem("zoom"))

			if ((result != NaN) && (result >= 0) & (result <= 19)) {
				return result
			}

			return 13
		}

	</script>

</div>